<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- BOOTSTRAP  -->
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="/webjars/bootstrap/5.3.0/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Leaflet imports   -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body>
    <div class="container-fluid w-75">
        <h1>Map</h1>
        <div id="map" style="height: 600px"></div>
        <div id="reports-data" th:text="${reports}" style="display:none;"></div>
    </div>
</body>
    <script>
        let lat = -34.34884;
        let lng = -58.801811;
        let map = null;
        let reportsDataElement = document.getElementById('reports-data');
        let reportsData = JSON.parse(reportsDataElement.textContent);

        //create report
        let popup = L.popup();
        function onMapClick(e) {
            let address = {town: undefined, road: undefined, country: undefined, village: undefined, city: undefined, suburb: undefined};
            $.getJSON("https://nominatim.openstreetmap.org/reverse?lat="+e.latlng.lat+"&lon="+e.latlng.lng+"&format=json",
                (data) => {
                    let content ='<form action="/reports/new" method="get">' +
                    '           <input type="hidden" name="latitude" value='+e.latlng.lat+'>' +
                    '           <input type="hidden" name="longitude" value='+e.latlng.lng+'>';
                    if (data.address !== undefined){
                        for (let key in data.address)
                            if (address.hasOwnProperty(key))
                                address[key] = data.address[key];
                        console.log(address);
                    }

                    if (address.city !== undefined)
                        content += '<input type="hidden" name="city" value="'+address.city+'">';
                    else if (address.village !== undefined)
                        content += '<input type="hidden" name="village" value="'+address.village+'">';
                    else if (address.town !== undefined)
                        content += '<input type="hidden" name="town" value="'+address.town+'">';
                    else if (address.suburb !== undefined)
                        content += '<input type="hidden" name="town" value="'+address.town+'">';

                    if (address.road !== undefined)
                        content += '<input type="hidden" name="road" value="'+address.road+'">';

                    if (address.country !== undefined)
                        content += '<input type="hidden" name="country" value="'+address.country+'">';

                    if (address.town === undefined && address.city === undefined && address.village === undefined && address.suburb === undefined)
                        content = "Por favor elige un lugar v√°lido"
                    else
                        content += '<button class="btn btn-link link-dark" type="submit">Make a new report!</button></form>';
                    popup
                        .setLatLng(e.latlng)
                        .setContent(content)
                        .openOn(map);
            });
        }

        function getCoordinates() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    console.log(navigator.geolocation)
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            lat = position.coords.latitude;
                            lng = position.coords.longitude;
                            resolve();
                        },
                        (error) => resolve()
                    );
                } else {
                    reject(new Error("Geolocation is not supported"));
                }
            });
        }

        function setMapView() {
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                attribution: '&copy; <a href="http://google.com/copyright">Google Maps</a>',
                subdomains:['mt0','mt1','mt2','mt3']
            }).addTo(map);
        }

        function mapEvent() {
            map.on('click', onMapClick);
        }

        // Usage: Execute the functions in order using promises
        getCoordinates()
            .then(() => setMapView())
            .then(() => mapEvent())
            .then(() => setReportsOnMap(reportsData))
            .catch((error) => {});

        function setReportsOnMap(reports){
            for (let i = 0; i < reports.length; i++)
                setMarker(reports[i]);
        }

        function setMarker(report){
            L.marker([report.lat, report.lng])
                .bindPopup("<p>"+report.title+"</p><p>"+report.location+"</p>")
                .addTo(map);
        }
    </script>
</html>