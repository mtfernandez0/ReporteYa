<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mi perfil</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col text-center">
                <h1>
                    Bienvenido <span th:text="${user.first_name+' '+user.last_name}"></span>
                </h1>
            </div>
        </div>
        <br>

        <div class="col text-center">
            <div class="row ">
                <div class="col-3">
                    <div class="d-flex justify-content-between">
                        <a href="/">Inicio</a>
                        <a href="/companies/new">Registrar compania</a>
                        <a th:href="@{/reports/{id}(id=${user.id})}">Mis reportes</a>
                    </div>
                </div>
                <div class="col-9">
                    <div class="d-flex justify-content-end align-item-center">
                        <form th:action="@{/logout}" method="post">
                            <input class="btn btn-link" type="submit" value="Cerrar sesión"/>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <p class="text-bg-info" th:if="${newReportNoContact != null}">
                Antes de poder crear un reporte, es necesario que completes tu información de usuario.
            </p>
            <div th:if="${user.contact == null}" class="mt-4">
                <h3>Tu información:</h3>
                <form id="form-post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <h3>Tu información:</h3>
                        <div class="mb-3">
                            <label for="number-post" class="form-label">Número:</label>
                            <input type="text" id="number-post" name="number-post" class="form-control" autofocus/>
                        </div>
                        <div class="mb-3">
                            <label for="country-post" class="form-label">País:</label>
                            <input type="text" id="country-post" name="country-post" class="form-control" placeholder="Argentina"/>
                        </div>
                        <div class="mb-3">
                            <label for="city-post" class="form-label">Ciudad:</label>
                            <input type="text" id="city-post" name="city-post" class="form-control" placeholder="Buenos Aires"/>
                        </div>
                        <div class="mb-3">
                            <label for="state-post" class="form-label">Estado/Localidad:</label>
                            <input type="text" id="state-post" name="state-post" class="form-control" placeholder="Escobar"/>
                        </div>
                    <button id="btn-post" type="submit" class="btn btn-outline-info">Guardar</button>
                </form>
            </div>
            <div th:if="${user.contact != null}" class="mt-4">
                <h3>Tu información:</h3>
                <form id="form-put">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div class="mb-3">
                        <label for="number-put" class="form-label">Número:</label>
                        <input type="text" id="number-put" name="number-put" class="form-control" th:value="${contact.number}"/>
                    </div>
                    <div class="mb-3">
                        <label for="country-put" class="form-label">País:</label>
                        <input type="text" id="country-put" name="country-put" class="form-control" th:value="${contact.country}"/>
                    </div>
                    <div class="mb-3">
                        <label for="city-put" class="form-label">Ciudad:</label>
                        <input type="text" id="city-put" name="city-put" class="form-control" th:value="${contact.city}"/>
                    </div>
                    <div class="mb-3">
                        <label for="state-put" class="form-label">Estado/Localidad:</label>
                        <input type="text" id="state-put" name="state-put" class="form-control" th:value="${contact.town}"/>
                    </div>
                    <button id="btn-put" class="btn btn-outline-info">Actualizar</button>
                </form>
            </div>
        </div>
    </div>
</body>
<script>
    function searchAndReplace(btn) {
        let replaceButton = document.getElementById(btn);
        let savingButton = '<button id="btn-search" class="btn btn-secondary disabled">Guardando...</button>';
        replaceButton.insertAdjacentHTML('afterend', savingButton);
        replaceButton.remove();
    }
    const csrfToken = $("input[name='_csrf']").val();

    $("#btn-post").on("click", (e) => {
        e.preventDefault(); // Prevent the default form submission

        searchAndReplace("btn-post");

        let country = $("input[name='country-post']").val();
        let city = $("input[name='city-post']").val();
        let state = $("input[name='state-post']").val();
        let place = state + " " + city + " " + country;
        let url = "https://nominatim.openstreetmap.org/search?addressdetails=1&q="+place+"&format=json&limit=1";

        (async () => {
            try {
                const data = await $.ajax({
                    type: "GET",
                    url: url,
                    dataType: 'json'
                });
                if (data !== undefined && data[0].address !== undefined && data[0].address.state_district !== undefined) {
                    let formData = {
                        country: data[0].address.country,
                        city: city,
                        state: state,
                        state_district: data[0].address.state_district
                    }

                    await (async () => {
                        try {
                            await $.ajax({
                                type: "POST",
                                url: "/profile",
                                headers: {
                                    "X-CSRF-TOKEN": csrfToken,
                                    "Content-Type": "application/json"
                                },
                                contentType: "application/json", // Set content type to JSON
                                data: JSON.stringify(formData)
                            })
                        } catch (error) {
                            console.log(error)
                        }
                    })();
                }
            } catch (error) {
                console.log(error)
            } finally {
                location.reload();
            }
        })();
    });

    $("#btn-put").on("click", (e) => {
        e.preventDefault(); // Prevent the default form submission

        searchAndReplace("btn-put");

        let country = $("input[name='country-put']").val();
        let city = $("input[name='city-put']").val();
        let state = $("input[name='state-put']").val();
        let place = state + " " + city + " " + country;
        console.log(place)
        let url = "https://nominatim.openstreetmap.org/search?addressdetails=1&q="+place+"&format=json&limit=1";

        (async () => {
            try {
                const data = await $.ajax({
                    type: "GET",
                    url: url,
                    dataType: 'json'
                });
                if (data !== undefined && data[0].address !== undefined && data[0].address.state_district !== undefined) {
                    let formData = {
                        country: data[0].address.country,
                        city: city,
                        state: state,
                        state_district: data[0].address.state_district
                    }

                    await (async () => {
                        try {
                            await $.ajax({
                                type: "PUT",
                                url: "/profile",
                                headers: {
                                    "X-CSRF-TOKEN": csrfToken,
                                    "Content-Type": "application/json"
                                },
                                contentType: "application/json", // Set content type to JSON
                                data: JSON.stringify(formData)
                            })
                        } catch (error) {
                            console.log(error)
                        }
                    })();
                }
            } catch (error) {
                console.log(error)
            } finally {
                location.reload();
            }
        })();
    });
</script>
</html>