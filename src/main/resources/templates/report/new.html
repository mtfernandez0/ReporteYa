<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>Nuevo Reporte</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
	<script src="/webjars/bootstrap/5.3.0/js/bootstrap.min.js"></script>
	<style>
		#tag-input{
			resize: none;
		}

		.tags-checks{
			display: flex;
			align-items: center;
			padding: 0 7px;
			border-radius: 8px;
			background-color: black;
			color: white;
			font-size: 20px;
		}

		.custom-checkbox {
			display: none;
		}
	</style>
</head>
<body>
	<div class="container-fluid w-75 w-75 mt-5">
		<h1>Nuevo reporte</h1>
		<form th:action="@{/reports/new}" method="post" th:object="${report}" enctype="multipart/form-data">
			<input type="hidden" name="country" th:value="${marker.country}">
			<input type="hidden" name="postcode" th:value="${marker.postcode}">
			<input type="hidden" name="location_name" th:value="${marker.location_name}">
			<input type="hidden" name="latitude" th:value="${marker.latitude}">
			<input type="hidden" name="longitude" th:value="${marker.longitude}">

			<p th:text="${'Locación: ' + marker.location_name}"></p>

			<label for="title">Problema</label><br>
			<input type="text" name="title" id="title" required th:value="${report.title}"> <br>
			<p class="text-danger" th:if="${#fields.hasErrors('title')}">
				<span class="row" th:each="error : ${#fields.errors('title')}" th:text="${error}"></span>
			</p>
			<label for="description">Descripción del problema</label> <br>
			<textarea id="description" name="description" required th:value="${report.description}"></textarea><br>
			<p class="text-danger" th:if="${#fields.hasErrors('description')}">
				<span class="row" th:each="error : ${#fields.errors('description')}" th:text="${error}"></span>
			</p>
<!--			<input type="text" name="tag" id="tags" th:value="${tags}"><br>-->
			<p class="text-danger" th:if="${#fields.hasErrors('tags')}">
				<span class="row" th:each="error : ${#fields.errors('tags')}" th:text="${error}"></span>
			</p>
			<p>Tags</p>
			<div id="tags-div" class="d-flex gap-2">
				<div id="tag-input-container" style="display: none;">
					<textarea class="px-2 rounded-3 bg-dark text-white" type="text" id="tag-input" rows="1"></textarea>
				</div>
				<p id="tag" class="tags-checks">&#43;</p>
			</div>
			<label for="additional_directions">Direcciones Adicionales</label> <br>
			<input type="text" name="additional_directions" id="additional_directions"
				th:value="${report.additional_directions}"><br>
			<br>
			<div class="d-flex gap-3 align-items-center">
				<p class="text-danger" th:if="${maxUploadSizeExceeded != null}">
					Imagen muy pesada. (hasta 2000KB por imagen)
				</p>
				<p class="text-danger" th:if="${#fields.hasErrors('images')}">
					<span class="row" th:each="error : ${#fields.errors('images')}" th:text="${error}"></span>
				</p>	     		<label class="btn btn-outline-secondary" for="files">Subir fotos</label>
				<input type="file" id="files" name="files" style="display:none;" accept="image/png, image/jpeg" multiple />
				<p id="text-files-space" class="m-0" ></p>
			</div>
			<br>
			<input type="submit" value="Crear Reporte">
		</form>
	</div>
	
</body>
<script>
	$(document).ready(function () {
		$('#files').change(() => {
			let i = $(this).prev('label').clone();
			let files = $('#files')[0].files;
			let text = "";
			if (files.length === 1) text = files[0].name;
			else if (files.length > 5) text = "Solo puede seleccionar hasta 5 archivos."
			else text = files.length + ' archivos seleccionados.';
			document.getElementById("text-files-space").innerHTML = text;
		});
	});

	const tagContainer = document.getElementById('tags-div');
	const tagButton = document.getElementById('tag');
	const tagInputContainer = document.getElementById('tag-input-container');
	const tagInput = document.getElementById('tag-input');

	tagButton.addEventListener('click', () => {
		if (document.getElementsByName('tags').length === 5) return;
		if (tagInputContainer.style.display === 'none') {
			tagInputContainer.style.display = 'block';
			tagInput.focus();
		} else {
			addTag(tagInput.value.trim());
		}
	});

	tagInput.addEventListener('keydown', (event) => {
		if (event.key === 'Enter') {
			addTag(tagInput.value.trim());
		}
	});

	function addTag(tagText) {
		if (tagText !== '') {
			const checkbox = document.createElement('input');
			checkbox.type = 'checkbox';
			checkbox.name = 'tag';
			checkbox.value = tagText;
			checkbox.className = 'custom-checkbox';
			checkbox.checked = true;

			const p = document.createElement('p');
			p.className = 'tags-checks checks';
			p.textContent = '#' + tagText;

			tagContainer.insertAdjacentElement('afterbegin', checkbox);
			tagContainer.insertAdjacentElement('afterbegin', p);

			tagInput.value = '';
			tagInputContainer.style.display = 'none';
		}
	}

</script>
</html>